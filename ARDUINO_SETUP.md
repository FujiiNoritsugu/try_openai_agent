# Arduino接続セットアップガイド

このガイドでは、Arduino Uno R4 WiFiを実際のPythonコードに接続してテストする手順を説明します。

## 必要なもの

### ハードウェア
- Arduino Uno R4 WiFi
- 振動モーター（3V-5V対応）
- ブレッドボード
- ジャンパーワイヤー
- 抵抗器（220Ω、オプション）

### ソフトウェア
- Arduino IDE (2.0以降推奨)
- ArduinoJson ライブラリ
- Python 3.8+
- 本プロジェクトの依存関係

## セットアップ手順

### 1. Arduino IDEの準備

1. Arduino IDEを開く
2. **ツール** → **ライブラリマネージャー** を開く
3. "ArduinoJson" で検索してインストール（バージョン6.x推奨）

### 2. ハードウェア接続

```
Arduino Uno R4 WiFi    振動モーター
==================    ===========
GND                 ── GND (黒)
Digital Pin 9       ── VCC (赤) ※PWM対応ピン
```

**注意**: 振動モーターの電流が大きい場合は、トランジスタを使用した回路を検討してください。

### 3. Arduinoコードの書き込み

1. `arduino_code/haptic_feedback_server.ino` をArduino IDEで開く
2. 以下の部分を編集：
   ```cpp
   const char* ssid = "YOUR_WIFI_SSID";        // WiFiのSSID
   const char* password = "YOUR_WIFI_PASSWORD"; // WiFiのパスワード
   ```
3. **ツール** → **ボード** → **Arduino Uno R4 WiFi** を選択
4. **ツール** → **ポート** → 適切なポートを選択
5. **アップロード** ボタンをクリック

### 4. ArduinoのIPアドレス確認

1. Arduino IDEの **シリアルモニタ** を開く（Ctrl+Shift+M）
2. ボーレート **115200** に設定
3. ArduinoをリセットしてWiFi接続を確認
4. シリアルモニタに表示されるIPアドレスをメモ

例:
```
WiFi接続成功!
IP アドレス: 192.168.1.123
Webサーバーが開始されました
```

### 5. Pythonテストの実行

```bash
# プロジェクトディレクトリに移動
cd /home/fujii/try_openai_agent

# 依存関係がインストールされていることを確認
pip install aiohttp pydantic

# テストスクリプトを実行
python test_arduino_connection.py
```

## テスト手順

### 基本テスト

1. テストスクリプトを実行
2. ArduinoのIPアドレスを入力
3. メニューから「1. シンプル振動テスト」を選択
4. 振動モーターが動作することを確認

### 感情パターンテスト

1. メニューから「2. 感情パターンテスト」を選択
2. 各感情（喜び、怒り、悲しみ、楽しさ）の振動パターンを確認
3. それぞれ異なる振動パターンが実行されることを確認

### インタラクティブテスト

1. メニューから「4. インタラクティブテスト」を選択
2. 数字キーで様々な振動強度をテスト
3. 'q'で終了

## トラブルシューティング

### WiFi接続の問題

**症状**: ArduinoがWiFiに接続できない
**解決策**:
- SSIDとパスワードを確認
- 2.4GHz WiFiネットワークを使用（5GHz未対応）
- WiFiルーターとの距離を確認

### 接続タイムアウト

**症状**: `Connection timeout` エラー
**解決策**:
- ArduinoのIPアドレスを再確認
- ファイアウォール設定を確認
- Arduinoを再起動

### 振動モーターが動かない

**症状**: 接続は成功するが振動しない
**解決策**:
- 配線を確認（特にGND接続）
- 振動モーターの動作電圧を確認
- 別のPWMピン（5, 6, 9, 10, 11）を試す

### パターン送信エラー

**症状**: `Pattern send failed` エラー
**解決策**:
- JSON形式のデータ確認
- Arduinoのメモリ不足の可能性
- シリアルモニタでエラーメッセージを確認

## 環境変数設定（オプション）

テスト用に環境変数を設定することも可能です：

```bash
export ARDUINO_HOST="192.168.1.123"
export ARDUINO_PORT="80"
export ARDUINO_TIMEOUT="10.0"
export ARDUINO_RETRY_COUNT="3"
```

## 安全に関する注意

1. **電流制限**: 振動モーターの電流仕様を確認
2. **発熱対策**: 長時間動作時の発熱に注意
3. **電源容量**: USB電源で不足する場合は外部電源を検討

## 次のステップ

基本的な接続が確認できたら：

1. 複数のArduinoを接続してテスト
2. WebSocketコントローラーも実装
3. 実際の感情分析パイプラインと統合
4. カスタム振動パターンの作成

## サポート

問題が発生した場合：
1. シリアルモニタのログを確認
2. Pythonコンソールのエラーメッセージを確認
3. 配線とコードの再確認